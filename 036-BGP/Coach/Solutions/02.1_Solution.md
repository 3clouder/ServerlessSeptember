# Challenge 2.1: Connecting VNG1 and CSR3 - Solution

There are two steps: first configuring the VNG connection and enable BGP:

```
az network vpn-connection update -n vng1tocsr3 -g $rg --enable-bgp true
```

And second, configure CSR3:

```
csr3=$(az network public-ip show -n csr3-pip -g $rg --query ipAddress -o tsv) && echo $csr3
vpngw_bgp_json=$(az network vnet-gateway show -n vng1 -g $rg --query 'bgpSettings')
vpngw_asn=$(echo "$vpngw_bgp_json" | jq -r '.asn') && echo $vpngw_asn
vpngw_gw0_bgp_ip=$(echo "$vpngw_bgp_json" | jq -r '.bgpPeeringAddresses[0].defaultBgpIpAddresses[0]') && echo $vpngw_gw0_bgp_ip
ssh -o BatchMode=yes -o StrictHostKeyChecking=no "$csr3" >/dev/null 2>&1 <<EOF
        config t
          router bgp 65100
            neighbor ${vpngw_gw0_bgp_ip} remote-as ${vpngw_asn}
            neighbor ${vpngw_gw0_bgp_ip} ebgp-multihop 5
            neighbor ${vpngw_gw0_bgp_ip} update-source GigabitEthernet1
        end
        wr mem
EOF
```

You can have a new look at the effective routes in Vnet1, now additional /16 prefixes advertised by CSR3 should be there (CSR advertises its local prefi 10.3.0.0/16 as well as the one for the MPLS core network learned from CSR5 via iBGP, 10.5.0.0/16):

<pre>
‚ùØ az network nic show-effective-route-table -n testvm1VMNic -g $rg -o table
Source                 State    Address Prefix    Next Hop Type          Next Hop IP
---------------------  -------  ----------------  ---------------------  --------------
Default                Active   10.1.0.0/16       VnetLocal
VirtualNetworkGateway  Active   10.2.0.4/32       VirtualNetworkGateway  40.127.161.185
VirtualNetworkGateway  Active   10.2.0.5/32       VirtualNetworkGateway  40.127.161.185
VirtualNetworkGateway  Active   10.3.0.10/32      VirtualNetworkGateway  40.127.161.185
VirtualNetworkGateway  Active   10.4.0.10/32      VirtualNetworkGateway  40.127.161.185
<b>VirtualNetworkGateway  Active   10.5.0.0/16       VirtualNetworkGateway  40.127.161.185
VirtualNetworkGateway  Active   10.3.0.0/16       VirtualNetworkGateway  40.127.161.185</b>
Default                Active   0.0.0.0/0         Internet
Default                Active   10.0.0.0/8        None
Default                Active   100.64.0.0/10     None
Default                Active   192.168.0.0/16    None
Default                Active   25.33.80.0/20     None
Default                Active   25.41.3.0/25      None
</pre>

You can inspect as well the different BGP commands on VNG1 to see its neighbors, what it is learning, and what it is advertising:

<pre>
<b>az network vnet-gateway list-bgp-peer-status -n vng1 -g $rg -o table</b>
Neighbor    ASN    State      ConnectedDuration    RoutesReceived    MessagesSent    MessagesReceived
----------  -----  ---------  -------------------  ----------------  --------------  ------------------
10.3.0.10   65100  Connected  00:02:56.0967494     2                 6               9
</pre>

<pre>
<b>az network vnet-gateway list-learned-routes -n vng1 -g $rg -o table</b>
Network       Origin    SourcePeer    AsPath    Weight    NextHop
------------  --------  ------------  --------  --------  ---------
10.1.0.0/16   Network   10.1.0.254              32768
10.2.0.4/32   Network   10.1.0.254              32768
10.2.0.5/32   Network   10.1.0.254              32768
10.3.0.10/32  Network   10.1.0.254              32768
10.4.0.10/32  Network   10.1.0.254              32768
10.5.0.0/16   EBgp      10.3.0.10     65100     32768     10.3.0.10
10.3.0.0/16   EBgp      10.3.0.10     65100     32768     10.3.0.10
</pre>

<pre>
<b>az network vnet-gateway list-advertised-routes -n vng1 -g $rg --peer 10.3.0.10 -o table</b>
Network       NextHop     Origin    AsPath    Weight
------------  ----------  --------  --------  --------
10.1.0.0/16   10.1.0.254  Igp       65001     0
10.2.0.4/32   10.1.0.254  Igp       65001     0
10.2.0.5/32   10.1.0.254  Igp       65001     0
10.4.0.10/32  10.1.0.254  Igp       65001     0
</pre>

Similarly, you can look at the different tables in CSR3. Let's start with the neighbor list. Notice that the number of prefixes received is the number of advertised routes that the `az network vnet-gateway list-advertised-routes` gave us earlier:

<pre>
ssh $csr3 "show ip bgp summary"

BGP router identifier 10.3.0.10, local AS number 65100
BGP table version is 8, main routing table version 8
7 network entries using 1736 bytes of memory
7 path entries using 952 bytes of memory
3/3 BGP path/bestpath attribute entries using 864 bytes of memory
1 BGP AS-PATH entries using 24 bytes of memory
0 BGP route-map cache entries using 0 bytes of memory
0 BGP filter-list cache entries using 0 bytes of memory
BGP using 3576 total bytes of memory
BGP activity 7/0 prefixes, 7/0 paths, scan interval 60 secs
7 networks peaked at 09:41:39 Dec 4 2020 UTC (00:05:59.164 ago)

Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
10.1.0.254      4        65001      19      21        7    0    0 00:13:55        4
10.5.0.10       4        65100    1422    1421        7    0    0 21:27:38        1
</pre>

You can safely ignore the 10.5.0.10 for now, it was pre-created by the deployment script to interconnect the branch to the MPLS core network.

We can have a look at the BGP route table, which will show the prefixes learnt over BGP. Note that the prefixes generated in the local AS (65100) have a path of `?`. Not too important, but this typically signals that the prefixes were injected via redistribution and not with a `network` command:

<pre>
ssh $csr3 "show ip bgp"

BGP table version is 8, local router ID is 10.3.0.10
Status codes: s suppressed, d damped, h history, * valid, > best, i - internal,
              r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter,
              x best-external, a additional-path, c RIB-compressed,
              t secondary path, L long-lived-stale,
Origin codes: i - IGP, e - EGP, ? - incomplete
RPKI validation codes: V valid, I invalid, N Not found

     Network          Next Hop            Metric LocPrf Weight Path
 *>   10.1.0.0/16      10.1.0.254                             0 65001 i
 r>   10.2.0.4/32      10.1.0.254                             0 65001 i
 r>   10.2.0.5/32      10.1.0.254                             0 65001 i
 *>   10.3.0.0/16      10.3.0.1                 0         32768 ?
 r>   10.4.0.10/32     10.1.0.254                             0 65001 i
 *>i  10.5.0.0/16      10.5.0.10                0    100      0 ?
</pre>

The `r` mark in the previous table means that a certain prefix learnt over BGP will not be converted into an actual route, because another route already exists. That being said, we can now see which routes appear in the route table coming from BGP, which should essentially be the prefix for Vnet1, plus 10.5.0.0/16 from the corporate network:

<pre>
ssh $csr3 "show ip route bgp"
[...]
B        10.1.0.0/16 [20/0] via 10.1.0.254, 00:17:17
B        10.5.0.0/16 [200/0] via 10.5.0.10, 21:31:00
</pre>

You can try other commands to see the learned routes:

<pre>
ssh $csr3 "show ip bgp neighbor 10.1.0.254 routes"
[...]
     Network          Next Hop            Metric LocPrf Weight Path
 *>   10.1.0.0/16      10.1.0.254                             0 65001 i
 r>   10.2.0.4/32      10.1.0.254                             0 65001 i
 r>   10.2.0.5/32      10.1.0.254                             0 65001 i
 r>   10.4.0.10/32     10.1.0.254                             0 65001 i

Total number of prefixes 4
</pre>

...and the advertised routes:

<pre>
ssh $csr3 "show ip bgp neig 10.1.0.254 advertised-routes"
[...]
     Network          Next Hop            Metric LocPrf Weight Path
 *>   10.3.0.0/16      10.3.0.1                 0         32768 ?
 *>i  10.5.0.0/16      10.5.0.10                0    100      0 ?

Total number of prefixes 3
</pre>
