# Challenge 2.3: Connect the rest of BGP adjacencies - Solution

We can enable BGP in the rest of the Azure VPN connections:

<pre>
az network vpn-connection update -n vng1tocsr4 -g $rg --enable-bgp true
az network vpn-connection update -n vng2tocsr3 -g $rg --enable-bgp true
az network vpn-connection update -n vng1tovng2a -g $rg --enable-bgp true
az network vpn-connection update -n vng1tovng2b -g $rg --enable-bgp true
az network vpn-connection update -n vng2tovng1a -g $rg --enable-bgp true
</pre>

And the Cisco routers:

```
csr3=$(az network public-ip show -n csr3-pip -g $rg --query ipAddress -o tsv) && echo $csr3
csr4=$(az network public-ip show -n csr4-pip -g $rg --query ipAddress -o tsv) && echo $csr4
vpngw_bgp_json=$(az network vnet-gateway show -n vng2 -g $rg --query 'bgpSettings')
vpngw_asn=$(echo "$vpngw_bgp_json" | jq -r '.asn') && echo $vpngw_asn
vpngw_gw0_bgp_ip=$(echo "$vpngw_bgp_json" | jq -r '.bgpPeeringAddresses[0].defaultBgpIpAddresses[0]') && echo $vpngw_gw0_bgp_ip
vpngw_gw1_bgp_ip=$(echo "$vpngw_bgp_json" | jq -r '.bgpPeeringAddresses[1].defaultBgpIpAddresses[0]') && echo $vpngw_gw1_bgp_ip
ssh -o BatchMode=yes -o StrictHostKeyChecking=no "$csr3" >/dev/null 2>&1 <<EOF
        config t
          router bgp 65100
            neighbor ${vpngw_gw0_bgp_ip} remote-as ${vpngw_asn}
            neighbor ${vpngw_gw0_bgp_ip} ebgp-multihop 5
            neighbor ${vpngw_gw0_bgp_ip} update-source GigabitEthernet1
            neighbor ${vpngw_gw1_bgp_ip} remote-as ${vpngw_asn}
            neighbor ${vpngw_gw1_bgp_ip} ebgp-multihop 5
            neighbor ${vpngw_gw1_bgp_ip} update-source GigabitEthernet1
            neighbor 10.4.0.10 remote-as 65100
            neighbor 10.4.0.10 update-source GigabitEthernet1
        end
        wr mem
EOF
vpngw_bgp_json=$(az network vnet-gateway show -n vng1 -g $rg --query 'bgpSettings')
vpngw_asn=$(echo "$vpngw_bgp_json" | jq -r '.asn') && echo $vpngw_asn
vpngw_gw0_bgp_ip=$(echo "$vpngw_bgp_json" | jq -r '.bgpPeeringAddresses[0].defaultBgpIpAddresses[0]') && echo $vpngw_gw0_bgp_ip
ssh -o BatchMode=yes -o StrictHostKeyChecking=no "$csr4" >/dev/null 2>&1 <<EOF
        config t
          router bgp 65100
            neighbor ${vpngw_gw0_bgp_ip} remote-as ${vpngw_asn}
            neighbor ${vpngw_gw0_bgp_ip} ebgp-multihop 5
            neighbor ${vpngw_gw0_bgp_ip} update-source GigabitEthernet1
            neighbor 10.3.0.10 remote-as 65100
            neighbor 10.3.0.10 update-source GigabitEthernet1
        end
        wr mem
EOF
```

We can check the neighbor tables:

<pre>
az network vnet-gateway list-bgp-peer-status -n vng1 -g $rg -o table
Neighbor    ASN    State      ConnectedDuration    RoutesReceived    MessagesSent    MessagesReceived
----------  -----  ---------  -------------------  ----------------  --------------  ------------------
10.2.0.5    65002  Connected  00:01:51.9049121     6                 13              8
10.3.0.10   65100  Connected  00:32:28.5519667     4                 45              50
10.4.0.10   65100  Connected  00:01:01.3476157     5                 8               12
10.2.0.4    65002  Connected  00:01:51.9361933     6                 15              10
</pre>

<pre>
az network vnet-gateway list-bgp-peer-status -n vng2 -g $rg -o table
Neighbor    ASN    State      ConnectedDuration    RoutesReceived    MessagesSent    MessagesReceived
----------  -----  ---------  -------------------  ----------------  --------------  ------------------
<p style="color:blue">10.1.0.254  65001  Connected  00:02:12.8925106     7                 6               10
10.3.0.10   65100  Connected  00:01:34.3342228     6                 8               11
10.4.0.10   65100  Connected  00:13:13.0890798     5                 24              30
10.2.0.4    65002  Connected  21:58:03.4434893     7                 1537            1539
10.2.0.5    65002  Unknown                         0                 0               0
<p style="color:red">10.1.0.254  65001  Connected  00:02:12.9501653     7                 8               9
10.3.0.10   65100  Connected  00:01:31.8210057     6                 8               11
10.4.0.10   65100  Connected  00:13:16.7998186     5                 23              30
10.2.0.4    65002  Unknown                         0                 0               0
10.2.0.5    65002  Connected  21:58:03.5277380     7                 1537            1539
</pre>

<pre>
ssh $csr3 "sh ip bgp summ"
[...]
Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
10.1.0.254      4        65001      46      51       16    0    0 00:33:04        5
10.2.0.4        4        65002       8      11       16    0    0 00:01:47        5
10.2.0.5        4        65002       9      11       16    0    0 00:01:49        5
10.4.0.10       4        65100       9       9       16    0    0 00:01:33        7
10.5.0.10       4        65100    1443    1445       16    0    0 21:46:47        1
</pre>

<pre>
ssh $csr4 "sh ip bgp summ"
[...]
Neighbor        V           AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
10.1.0.254      4        65001      46      51       16    0    0 00:33:04        5
10.2.0.4        4        65002       8      11       16    0    0 00:01:47        5
10.2.0.5        4        65002       9      11       16    0    0 00:01:49        5
10.4.0.10       4        65100       9       9       16    0    0 00:01:33        7
10.5.0.10       4        65100    1443    1445       16    0    0 21:46:47        1
</pre>
